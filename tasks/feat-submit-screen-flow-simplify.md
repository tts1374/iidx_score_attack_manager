# Plan: feat/submit-screen-flow-simplify

## 目的

- 提出画面を「画像登録専用」に再定義し、画像選択時の自動ローカル保存を実現する。
- 提出（共有）操作を詳細画面に限定し、保存と提出の責務を分離する。
- 提出画面ヘッダーを2行構成へ圧縮し、長曲名でも崩れない表示へ変更する。
- 難易度に応じたテキスト色を `{DIFFICULTY} {LEVEL}` 全体へ適用する。

## 非目的

- DBスキーマ変更（`user_version` 更新、マイグレーション追加）は行わない。
- Web Locks / Service Worker / import-export / 起動シーケンスには手を入れない。
- ホーム画面や設定画面の挙動・デザイン変更は行わない。

## 変更点

- 提出画面:
  - 大会名表示、3点メニュー、削除操作を撤去。
  - `Step 1 / Step 2` 表記を撤去。
  - 「更新する/保存する」ボタンを撤去し、画像選択時に即保存する方式へ変更。
  - 画像入力UIを縦2ボタン（`撮影する` / `画像を選ぶ`）へ変更し、導線を明示する。
  - `撮影する` はカメラ直接起動（`capture`）を試行し、PCでは非表示または無効化する。
  - `画像を選ぶ` はOSネイティブファイル選択を利用する。
  - 保存成功時に詳細画面へ自動で戻る。
  - ヘッダーを `曲名(最大2行)` + `{SP|DP} {DIFFICULTY} {LEVEL}(1行)` に固定。
  - 難易度行に難易度別カラーを適用し、ダーク配色向けの変数を追加。
  - 状態語彙を `未登録 / 未共有 / 共有済` に統一する。
  - 状態バッジをヘッダー右（曲名行）へ集約し、下部状態表示を撤去する。
  - 保存仕様カードを廃止し、1行補助テキスト（枠/背景なし）へ変更する。
- 詳細画面:
  - 提出ボタンの表示条件を `local_saved`（ローカル保存済の譜面存在）基準へ変更。
  - ラベルを状態で切り替え（未提出: `提出する` / 提出済: `再提出する`）。
  - 再提出時は上書きになる旨を確認ダイアログに表示。
  - 譜面カード右側アクションを状態別の視覚階層へ調整する。
    - 未登録: `登録する` を主ボタン（塗り）
    - 未共有/共有済: `差し替え` をセカンダリ（アウトライン）
- 状態管理:
  - `local_saved` と `submitted` を分離した判定関数を導入し、UI分岐も同判定で統一。

## 影響範囲（ユーザー / データ / 互換性）

- ユーザー:
  - 提出画面の操作が「画像を選ぶ」中心に簡略化される。
  - 共有操作は詳細画面に集約される。
- データ:
  - 画像保存時の `evidences` upsert（`needs_send=1`）既存仕様を継続利用。
  - 既存データ形式や永続化フォーマットは変更しない。
- 互換性:
  - 既存大会データとの互換性を維持。
  - 既存共有フロー（Web Share / fallback）は詳細画面側で継続。

## 実装方針（対象ファイル単位）

- `packages/web-app/src/pages/SubmitEvidencePage.tsx`
  - 画像選択時即保存のフローへ変更。
  - `撮影する` / `画像を選ぶ` の縦2ボタン導線へ変更。
  - カメラ未対応時のエラー処理を追加。
  - 状態表示をヘッダー右バッジへ移動し、`local_saved/submitted` から状態を決定する。
  - 保存説明を1行補助テキストへ変更し、下部カードの状態語彙を削除する。
  - ヘッダーと保存状態UIを新仕様へ変更。
  - 削除/ステップ/手動保存UIを削除。
- `packages/web-app/src/pages/TournamentDetailPage.tsx`
  - `local_saved` / `submitted` 判定ロジックを導入。
  - 提出ボタン表示条件、文言、再提出確認メッセージを調整。
  - 共有対象チャートの選定を「通常提出/再提出」で切り替える。
  - 譜面カード右側アクションのボタン種別を状態に応じて分離する。
- `packages/web-app/src/styles.css`
  - 提出画面ヘッダー2行表示・長曲名折返し・1行難易度メタのスタイルを追加。
  - 難易度カラー変数（通常/ダーク相当）を追加。
  - 譜面カード右側アクションの主/副ボタンスタイルを最小差分で調整。
- `packages/web-app/src/i18n/locales/ja.json`
- `packages/web-app/src/i18n/locales/en.json`
- `packages/web-app/src/i18n/locales/ko.json`
  - 提出画面と詳細画面に必要な新文言を追加/更新。
- `packages/web-app/src/pages/TournamentDetailPage.test.tsx`
  - 提出ボタン表示条件と文言変更に合わせてテストを更新。

### 変更スコープ固定

- 上記ファイル以外は変更しない。

## テスト観点

- 提出画面:
  - 長曲名が2行で省略表示され、ヘッダー崩れがない。
  - 難易度行が `{SP|DP} {DIFFICULTY} {LEVEL}` 形式で1行表示される。
  - モバイルで `撮影する` / `画像を選ぶ` が縦配置・同幅で表示される。
  - PCでは `撮影する` が非表示または無効化される。
  - カメラ未対応時に明示的なエラー表示が出る。
  - ヘッダー右バッジのみで状態判別できる（未登録/未共有/共有済）。
  - 下部に状態語彙（未提出/未送信/保存済）が存在しない。
  - 保存仕様は1行補助テキストのみ（枠なし・背景なし・複数行化しない）。
  - 画像選択後に自動保存され、詳細画面に戻る（`onSaved('submit')` 呼び出し）。
  - Step表記/更新ボタン/削除導線が存在しない。
- 詳細画面:
  - `local_saved=true` のときのみ提出ボタンを表示。
  - 状態に応じて `提出する` / `再提出する` が切り替わる。
  - 再提出時に上書き説明が表示される。
  - 未登録カードのみ `登録する` が塗りボタンで表示される。
  - 未共有/共有済カードの `差し替え` がアウトラインで表示される。
  - 登録と差し替えが同一スタイルになっていない。
- 回帰:
  - 既存の共有成功時 `needs_send` 更新とUNDOが動作する。

## ロールバック方針

- 変更を以下コミット単位で切り戻せるよう分割する。
  1. 提出画面UI/フロー変更
  2. 詳細画面提出ロジック変更
  3. 文言・テスト更新
- 不具合時は該当コミットを `git revert` して段階的に復旧する。

## Commit Plan（コミット分割計画）

1. `SubmitEvidencePage` のフロー簡略化（自動保存・削除撤去・ヘッダー再構成）と関連CSS追加。
2. `TournamentDetailPage` の `local_saved/submitted` 判定導入と提出ボタン挙動変更。
3. i18n辞書更新（ja/en/ko）と `TournamentDetailPage.test.tsx` 更新。

## 実行チェックリスト

- [x] 変更が宣言スコープ内に限定されていることを確認
- [x] `pnpm --filter @iidx/web-app lint`
- [x] `pnpm --filter @iidx/web-app test -- --run src/pages/TournamentDetailPage.test.tsx`
- [x] `git diff` で無関係差分/改行・エンコーディング崩れがないことを確認

Validation note:
- `pnpm --filter @iidx/web-app lint` pass。
- `pnpm --filter @iidx/web-app test -- --run src/pages/TournamentDetailPage.test.tsx` pass（vitest仕様により複数テストファイル実行）。
