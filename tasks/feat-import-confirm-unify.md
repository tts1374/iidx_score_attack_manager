# Plan: feat-import-confirm-unify

## 目的

- 取り込み確認画面の上部レイアウトをスコアタ詳細画面の上部カードに寄せ、視覚的な一貫性を高める。
- 取り込み確認画面で通常表示されてしまう大会ID（UUID）を除外し、デグレを修正する。
- 取り込み時の差分サマリを上部カード直下の1行で明示し、更新/新規作成の意図を誤解なく伝える。
- 取り込み確認とスコアタ詳細の譜面メタ表記を `PLAYSTYLE DIFFICULTY LEVEL` 形式へ統一する。
- 取り込み確認の注意文を新仕様へ差し替える。
- スコア提出 / スコアタ詳細 / 取り込み確認 の楽曲カードUIを共通化し、差分を右側UIのみに限定する。
- 一覧/詳細/取り込み確認の大会情報カードを共通骨格化し、variantで表示要素を統一する。

## 非目的

- Import ロジック（`isExistingTournament` 判定や DB 更新処理）の仕様変更。
- Web Locks / Service Worker / 起動シーケンス / DB schema の変更。
- スコア提出の画像保存フロー変更（本タスクでは見た目統一のみ）。
- 依存関係追加・更新、CI/CD 変更。

## 変更点

- 取り込み確認画面:
  - 上部カードを詳細画面と同等構造で描画（タイトル、状態バッジ、期間、ハッシュタグ）。
  - 大会IDの通常表示を行わない。
  - 上部カード直下に `isExistingTournament` に応じた1行サマリを表示。
  - 対象譜面を全件表示に変更（先頭4件制限を撤廃）。
  - 対象譜面セクション見出しを `対象譜面（count）` 形式に変更。
  - 注意文を2行固定文言へ差し替え。
  - 既存マージ詳細ブロック（件数表示）を撤去。
- 譜面表記:
  - `formatChartLabel(chart)` を導入し、`{playStyle} {difficulty} {level}` を返す共通化を実施。
  - スコアタ詳細/取り込み確認の譜面メタ表示で同関数を使用。
  - `・` / `•` / `Lv` を当該2画面から除去。
- 文言:
  - `import.confirm` 配下の差分サマリ、対象譜面見出し、注意文、譜面詳細書式キーを更新。
  - 3言語（ja/en/ko）の同一キーを同期更新。
- 共通コンポーネント:
  - 上部カードを `TournamentSummaryCard` へ抽出し、詳細画面と取り込み確認画面で同一コンポーネントを利用する。
  - 楽曲カードを `ChartCard` へ抽出し、スコア提出/詳細/取り込み確認で同一コンポーネントを利用する。
- レビュー反映:
  - スコアタ詳細上部カードの「大会ID」表示と「詳細情報」アコーディオンを削除する。
  - 楽曲カードの左側（曲名+譜面表記）を3画面で完全統一し、画面差分を右側UI（status/actions）のみにする。
  - 譜面表記を `SP/DP`（無色）+ `DIFFICULTY LEVEL`（difficulty CSS変数色）へ分割描画し、提出画面の見た目を元デザイン基準へ戻す。
  - statusバッジは `unregistered` / `unshared` のみ表示し、`shared` はカード内非表示にする。
  - detailは「右上=アクション専用」「statusバッジ=左側固定行」に分離して競合を防止する。
  - submitはstatusバッジを譜面行右端に固定し、本文下への縦積みを禁止する。
  - submitは狭幅時にstatusバッジを非表示化し、縦積み回避を優先する。
  - detailの右側アクションを縦中央寄せに固定し、カードごとの揺れを抑制する。
  - detailを3段同期構造へ変更し、右側アクションを常に3段目へ固定する（バッジ有無で位置不変）。
  - detailのモバイル表示では右側固定カラムを廃止し、バッジ行とアクションボタンを同段（左バッジ/右ボタン）に再配置する。
  - detailのモバイル表示で曲名可読性を優先し、タイトルの2行表示領域を確保する（右固定カラムによる過度省略を解消）。
  - 大会情報カードを `list/detail/preview` の共通骨格へ統一し、要素表示をvariantで制御する。
  - 状態行の右側相対表示を状態別に切替（開催前=開始まで、開催中=残り日数、終了=非表示）。
  - 一覧カードの状態行は `space-between` を使わず、固定gapで左詰め表示にして状態と相対日数の間延びを防ぐ。
  - 大会カード④は強いバッジ表示を廃止し、未完了のみの軽量な状態ラベル（未登録/未共有）へ変更する。
  - 未完了ラベルは `未登録` / `未共有` のみ（0は非表示、共有済は非表示）に統一する。
  - list/detailで進捗バーの見た目と算出を共通化し、previewでは進捗関連要素を非表示にする。

## 影響範囲（ユーザー / データ / 互換性）

- ユーザー:
  - 取り込み確認画面の見た目と情報提示順が変わる。
  - 取り込み時に「新規作成/既存更新」の区別が1行で明示される。
  - スコア提出/詳細/取り込み確認で楽曲カードの見た目が統一される。
- データ:
  - 保存データ形式、payload、DB内容への影響なし。
- 互換性:
  - 既存 import 実行フローとボタン動作は維持。

## 実装方針（対象ファイル単位）

- `packages/web-app/src/utils/chart-label.ts`（新規）
  - 譜面ラベル共通フォーマッタ `formatChartLabel` を実装。
- `packages/web-app/src/components/TournamentSummaryCard.tsx`（新規）
  - 大会情報カード共通コンポーネントを実装（`variant=list/detail/preview`）。
  - 要素①〜⑦（状態行、タイトル、期間、未完了ラベル、進捗バー、詳細導線、共有導線）をvariantで出し分ける。
  - 終了時は相対日数を非表示、開催前/開催中のみ右側相対表示を描画する。
  - list/detailの④を状態ラベル化し、`未登録 > 未共有` の順で最大2件のみ表示する。
- `packages/web-app/src/components/ChartCard.tsx`（新規）
  - 楽曲カード共通コンポーネントを実装（左側固定、右側status/actionsスロット可変）。
  - `playStyle` と `difficulty+level` を別spanで描画し、difficulty CSS変数クラスを適用。
  - variant別のstatus配置（submit=右上/detail=左側/preview=非表示）を実装。
  - submitでは譜面行を3カラム（style / diff+lv / status）で描画し、`ResizeObserver` による狭幅時status非表示を実装。
  - detailでは左カラムを「曲名/譜面行/バッジ行」の3段固定、右カラムを「spacer/spacer/action」の3段固定で描画。
  - detailではモバイル時に右側カラム描画を停止し、3段目（バッジ行）へアクションを合流表示する。
- `packages/web-app/src/pages/SubmitEvidencePage.tsx`
  - 既存ヘッダーの楽曲表示を `ChartCard` に置換（右側はステータスバッジのみ）。
- `packages/web-app/src/pages/ImportConfirmPage.tsx`
  - 上部カード構造と差分サマリ表示を更新。
  - 譜面一覧を全件表示、見出しに件数追加。
  - 譜面カード表示を `ChartCard` に置換（右側UIなし）。
  - 既存マージ詳細ブロックを撤去。
  - 注意文の新キーに置換。
  - 譜面ラベル表示を共通フォーマッタへ置換。
  - 大会カードを `preview` variant で表示（①②③のみ）。
- `packages/web-app/src/pages/TournamentDetailPage.tsx`
  - 上部カードを共通コンポーネントへ置換。
  - 譜面カード表示を `ChartCard` に置換（右側はstatus + actions）。
  - 譜面メタ表示を共通フォーマッタへ置換し、区切り記号なしへ変更。
  - 大会ID行と詳細情報アコーディオンを削除。
  - 大会カードを `detail` variant で表示し、①②③④⑤⑦を同一骨格に揃える。
- `packages/web-app/src/pages/HomePage.tsx`
  - 一覧カードを `list` variant へ置換し、①②④⑤⑥を同一骨格に揃える。
- `packages/web-app/src/styles.css`
  - 取り込み確認の上部カードと1行サマリ、セクション余白の最小スタイル調整。
  - 取り込み確認で不要になったマージカード用スタイルを整理。
  - `ChartCard` 共通スタイルを追加し、提出専用ヘッダーの重複スタイルを整理。
  - difficulty色クラス (`.chart-diff--*`) を `--difficulty-*` 変数のみで実装。
  - detailの左側status行固定高さと右側アクション幅固定を追加。
  - submit譜面行の3カラム化とバッジ右寄せ固定スタイルを追加。
  - detail右側アクションの中央寄せ固定スタイルを追加。
  - detail右側を3段同期レイアウトに変更し、3段目アクションスロットを追加。
  - detailモバイル表示で1カラム運用に切り替え、3段目のバッジ行を `space-between` 配置にして右端へアクションを配置する。
  - 大会情報カード共通骨格スタイル（状態行/未完了ラベル/進捗バー/variant差分）を追加・整理する。
  - 大会カード④を「バッジ」から「状態ラベル」見た目へ変更（控えめな背景・枠・文字サイズ）。
- `packages/web-app/src/i18n/locales/ja.json`
- `packages/web-app/src/i18n/locales/en.json`
- `packages/web-app/src/i18n/locales/ko.json`
  - 新仕様文言へ更新。
- `packages/web-app/src/pages/HomePage.test.tsx`
  - 一覧カードの要素表示（①②④⑤⑥）と未完了ラベル表示条件を更新・確認する。
- `packages/web-app/src/pages/TournamentDetailPage.test.tsx`
  - 譜面表記変更に伴う期待値更新。
  - 大会ID/詳細情報削除に伴うテスト更新。
  - `ChartCard` 置換後もstatus/actionsの表示仕様を維持することを確認。
  - 詳細カードで `detail` variant要素（①②③④⑤⑦）が表示されることを確認する。

### 変更スコープ固定

- 上記ファイル以外は変更しない。

## テスト観点

- 取り込み確認:
  - 上部カードにタイトル/状態/期間/ハッシュタグが表示される。
  - UUID が通常表示されない。
  - 差分サマリが `isExistingTournament` に応じて切り替わる。
  - 対象譜面が全件表示される。
  - セクション見出しに件数が含まれる。
  - 注意文が2行固定文言に置換される。
- 譜面表記:
  - 取り込み確認・詳細画面・提出画面の表示が `DP ANOTHER 10` 形式。
  - `・` / `•` / `Lv` が当該2画面のDOMテキストに含まれない。
- 楽曲カード:
  - 3画面で左側（曲名+譜面表記）のDOM構造とクラスが共通化されている。
  - 画面差分が右側UIのみ（提出: statusのみ / 詳細: status+actions / 取り込み: 右側なし）。
  - 譜面行で `SP/DP` は無色、`DIFFICULTY LEVEL` は `--difficulty-*` 色で描画される。
  - card内statusは `unregistered` / `unshared` のみ表示され、`shared` は表示されない。
  - submitでstatusバッジが本文下に落ちず、狭幅では非表示になる。
  - detailで右側はアクションのみ、左側status行と競合しない。
  - detailでバッジ有無に関わらずアクションが常に3段目位置に固定される。
  - detailのモバイル幅では右側固定カラムを使用せず、バッジ行にアクションが同段表示される。
  - detailのモバイル幅で曲名が最大2行まで読める。
- 大会カード:
  - listは ①②④⑤⑥ のみ表示（③⑦は非表示）。
  - detailは ①②③④⑤⑦ のみ表示（⑥は非表示）。
  - previewは ①②③ のみ表示（④⑤⑥⑦は非表示）。
  - 状態行右側は `開催前=開始まで` / `開催中=残り` / `終了=非表示` で切替わる。
  - 一覧カードの状態行で状態ラベルと相対日数の間隔は固定で、右端へ張り付かない。
  - 未完了ラベルは `未登録` / `未共有` のみ表示され、0件・共有済は表示されない。
  - ④はlist/detailともに軽量な状態ラベル表現で、進捗バーの色意味（未登録=灰、未共有=黄橙）と一致する。
- 回帰:
  - 取り込み確認の `キャンセル` / `取り込む` 操作可否条件が従来通り。
  - スコアタ詳細に大会IDと詳細情報が表示されないこと。

## ロールバック方針

- 本タスク差分をコミット単位で `git revert` し、画面表示を従来実装へ戻す。
- 追加ユーティリティ `chart-label.ts` は revert により削除されるため副作用なし。

## Commit Plan（コミット分割計画）

1. `plan`: tasks ファイル追加。
2. `chart-label`: 譜面ラベル共通ユーティリティ追加と詳細画面への適用。
3. `import-confirm-ui`: 取り込み確認のカード/差分サマリ/注意文/譜面一覧更新。
4. `i18n-and-tests`: 文言更新と関連テスト更新。
