# QUALITY.md

## 0. 完了の定義

タスクは「動作の証明」ができるまで完了と見なさない。\
ビルド成功・テスト成功・差分妥当性確認を必須とする。

------------------------------------------------------------------------

## 1. 技術的検証

-   ビルド成功（型エラーなし）
-   Lintエラーなし
-   テスト成功
-   破壊的変更なし
-   不要な依存追加なし

------------------------------------------------------------------------

## 2. 差分検証

-   変更対象以外に diff が存在しない
-   無関係な整形変更なし
-   import順のみ変更していない
-   生成物更新は意図的である

------------------------------------------------------------------------

## 3. 起動シーケンス検証

以下に変更がある場合は必ず確認する:

-   Service Worker controller獲得
-   crossOriginIsolated 判定と再読込
-   Web Locks取得
-   DB初期化（user_version）
-   サービス初期化順序

------------------------------------------------------------------------

## 4. Importフロー検証

-   base64デコード失敗
-   gzip展開失敗
-   JSONパース失敗
-   SCHEMA_ERROR
-   MASTER_MISSING
-   CHART_NOT_FOUND
-   既存大会期間矛盾

既存大会との互換性を壊していないこと。

------------------------------------------------------------------------

## 5. Evidence処理検証

-   JPEG再エンコード成功
-   SHA-256算出一致
-   OPFS原子的保存（tmp→検証→置換）維持
-   update_seq 正常増加
-   needs_send 遷移正当性
-   削除時 file_deleted=1, needs_send=0

reconcileEvidenceFiles の回帰確認必須。

------------------------------------------------------------------------

## 6. song master 更新検証

-   latest.json no-store取得
-   schema_version一致確認
-   byte_size検証
-   sha256検証
-   OPFS原子的保存
-   更新失敗時 local_cache 継続動作

------------------------------------------------------------------------

## 7. DB整合性

-   UNIQUE制約維持
-   user_version変更時はマイグレーション必須
-   データ破壊なし
-   既存大会データ保持

------------------------------------------------------------------------

## 8. Service Worker検証

-   キャッシュ名変更は意図的
-   fetch戦略の回帰確認
-   SKIP_WAITING → controllerchange → reload 確認

------------------------------------------------------------------------

## 9. Single-tab invariant

単一タブ凍結が維持されていること:

-   Web Locks名変更なし
-   競合状態が発生しない
-   委譲経路（BroadcastChannel / storage event）が維持されている

------------------------------------------------------------------------

## 10. リリース前確認

-   バージョン整合性
-   タグ正確性
-   変更履歴更新
-   再現手順確認
