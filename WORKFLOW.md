# WORKFLOW.md

## 0. 基本原則

- 1PR1目的。
- 目的外変更は分離する。
- 3ステップ以上の作業は必ず計画を書く。
- 状態機械を壊す変更は単独PRで扱う。

------------------------------------------------------------------------

## 1. プランモード

以下の場合は必ず tasks/<branch-or-pr-name>.md に計画を書く。
単一共有ファイルは使用しない。:

- 3ステップ以上の変更
- アーキテクチャ変更
- DB schema変更
- Service Worker変更
- Web Locks変更
- Payload仕様変更
- CI / デプロイ変更
- 依存関係更新

### 記載形式（例）

- [ ] 設計確認
- [ ] 影響範囲特定
- [ ] 実装
- [ ] テスト
- [ ] 回帰確認
- [ ] ドキュメント更新

------------------------------------------------------------------------

## 2. コミット計画の宣言

実装前にコミット粒度を明示する。

例:

1. 型追加
2. ロジック変更
3. UI調整
4. テスト修正
5. ドキュメント更新

コミットは論理単位で分離する。
整形のみの変更は別PR。

------------------------------------------------------------------------

## 3. Commit Execution Rules

コミット分割は「後工程」ではなく「実装工程の一部」とする。

### 3.1 原則

- 計画内の1項目 = 1論理コミット。
- 作業単位が完了したら即コミットする（逐次コミット）。
- `git status` は各コミット前にクリーンであること。
- 生成物更新は専用コミットに隔離する。
- 各コミット対象の作業を開始する前に、作業ツリーはクリーンでなければならない。
- 次のコミット対象に移る前に、必ずコミットして作業ツリーをクリーンに戻す。
- 作業完了（done）状態の定義は「作業ツリーがクリーン」であること。
- `git status` がクリーンでない状態で「完了」「done」「作業終了」を宣言してはならない。

### 3.2 差分混在の禁止

- 複数目的の差分を1コミットに混在させない。
- フォーマット変更は別PR。
- 機械生成差分と手動修正を混在させない。

### 3.3 混在した場合の処理順

1. `git add -p` 等で部分ステージを優先する。
2. `git reset`（mixed）で index を整理する。
3. 意図した差分のみを段階的にコミットする。

### 3.4 パッチ退避→再適用

以下の場合のみ許可する（最終手段）:

- 差分が大規模かつ分離困難
- rename / 移動 / 生成物混在で部分ステージが破綻する場合

実施した場合:

- PR本文に理由を明記する。
- 差分再適用漏れがないことを確認する。

------------------------------------------------------------------------

## 4. 状態遷移確認義務

以下に影響する変更は状態遷移を明示的に確認する:

- 起動シーケンス（SW / COI / Web Locks）
- Importフロー
- Evidence保存→needs_send更新
- reconcileEvidenceFiles
- song master更新フロー

------------------------------------------------------------------------

## 5. 互換性レビュー必須領域

以下を変更する場合は専用レビュー観点を設ける:

- Payloadフォーマット
- def_hash算出ロジック
- DB schema / user_version
- Service Worker fetch戦略
- song master検証ロジック

------------------------------------------------------------------------

## 6. Multi-tab initiative gate

単一タブ凍結を解除する場合は専用PRシリーズで実施する:

1) 設計ドキュメント作成（競合制御戦略、状態モデル）
2) 実装
3) 回帰・耐障害性確認
4) QUALITY.md 更新

機能追加と同時に実施しない。

------------------------------------------------------------------------

## 7. バグ対応方針

- 根本原因を特定する。
- 対症療法は禁止。
- 再発防止策を設計へ反映する。
- lessons.md に記録する。

------------------------------------------------------------------------

## 8. PR本文テンプレート

PRには以下を含める:

- 目的
- 変更点
- 非変更点
- 影響範囲
- テスト内容
- 回帰確認項目

------------------------------------------------------------------------

## 9. 完了条件（ワークフロー観点）

- 計画通りの差分のみ存在する。
- 目的外変更がない。
- QUALITY基準を満たす。
- `git status` がクリーンである（未コミット差分なし）。
- コミット分割計画の各項目がコミットとして存在する（または計画を更新して理由を残す）。