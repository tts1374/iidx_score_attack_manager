# WORKFLOW.md

## 0. 基本原則

-   1PR1目的。
-   目的外変更は分離する。
-   3ステップ以上の作業は必ず計画を書く。
-   状態機械を壊す変更は単独PRで扱う。

------------------------------------------------------------------------

## 1. プランモード

以下の場合は必ず tasks/<branch-or-pr-name>.md に計画を書く。
単一共有ファイルは使用しない。:

-   3ステップ以上の変更
-   アーキテクチャ変更
-   DB schema変更
-   Service Worker変更
-   Web Locks変更
-   Payload仕様変更
-   CI / デプロイ変更
-   依存関係更新

### 記載形式（例）

-   [ ] 設計確認
-   [ ] 影響範囲特定
-   [ ] 実装
-   [ ] テスト
-   [ ] 回帰確認
-   [ ] ドキュメント更新

------------------------------------------------------------------------

## 2. コミット計画の宣言

実装前にコミット粒度を明示する。

例:

1.  型追加
2.  ロジック変更
3.  UI調整
4.  テスト修正
5.  ドキュメント更新

コミットは論理単位で分離する。 整形のみの変更は別PR。

------------------------------------------------------------------------

## 3. 状態遷移確認義務

以下に影響する変更は状態遷移を明示的に確認する:

-   起動シーケンス（SW / COI / Web Locks）
-   Importフロー
-   Evidence保存→needs_send更新
-   reconcileEvidenceFiles
-   song master更新フロー

------------------------------------------------------------------------

## 4. 互換性レビュー必須領域

以下を変更する場合は専用レビュー観点を設ける:

-   Payloadフォーマット
-   def_hash算出ロジック
-   DB schema / user_version
-   Service Worker fetch戦略
-   song master検証ロジック

------------------------------------------------------------------------

## 5. Multi-tab initiative gate

単一タブ凍結を解除する場合は専用PRシリーズで実施する:

1)  設計ドキュメント作成（競合制御戦略、状態モデル）
2)  実装
3)  回帰・耐障害性確認
4)  QUALITY.md 更新

機能追加と同時に実施しない。

------------------------------------------------------------------------

## 6. バグ対応方針

-   根本原因を特定する。
-   対症療法は禁止。
-   再発防止策を設計へ反映する。
-   lessons.md に記録する。

------------------------------------------------------------------------

## 7. PR本文テンプレート

PRには以下を含める:

-   目的
-   変更点
-   非変更点
-   影響範囲
-   テスト内容
-   回帰確認項目

------------------------------------------------------------------------

## 8. 完了条件（ワークフロー観点）

-   計画通りの差分のみ存在する。
-   目的外変更がない。
-   QUALITY基準を満たす。
